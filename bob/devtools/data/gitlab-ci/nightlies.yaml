# This YAML file contains descriptions for the CI of nightly builds of Bob and
# BEAT.

# Definition of global variables (all stages)
variables:
  PYTHONUNBUFFERED: "1"
  CONDA_ROOT: "${CI_PROJECT_DIR}/miniconda"
  BOOTSTRAP: "https://gitlab.idiap.ch/bob/bob.devtools/raw/master/bob/devtools/bootstrap.py"


# Definition of our build pipeline order
stages:
  - build
  - cleanup


# Build targets
.build_template:
  stage: build
  variables:
    CONDA_ROOT: "${CI_PROJECT_DIR}/miniconda"
    PYTHONUNBUFFERED: 1
  script:
    - curl --silent "${BOOTSTRAP}" --output "bootstrap.py"
    - python3 bootstrap.py -vv channel base
    - source ${CONDA_ROOT}/etc/profile.d/conda.sh
    - conda activate base
    - bdt ci nightlies -vv order.txt
    - bdt ci clean -vv
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - miniconda.sh
      - ${CONDA_ROOT}/pkgs/*.tar.bz2
      - ${CONDA_ROOT}/pkgs/urls.txt

build_linux_36:
  extends: .build_template
  variables:
    PYTHON_VERSION: "3.6"
  tags:
    - docker

build_linux_37:
  extends: .build_template
  variables:
    PYTHON_VERSION: "3.7"
  tags:
    - docker

build_macosx_36:
  extends: .build_template
  variables:
    PYTHON_VERSION: "3.6"
  tags:
    - macosx

build_macosx_37:
  extends: .build_template
  variables:
    PYTHON_VERSION: "3.7"
  tags:
    - macosx


# Periodic cleanup of beta packages
.cleanup_template:
  stage: cleanup
  tags:
    - docker
  image: continuumio/conda-concourse-ci
  script:
    - curl --silent "${BOOTSTRAP}" --output "bootstrap.py"
    - python3 bootstrap.py -vv channel base
    - source ${CONDA_ROOT}/etc/profile.d/conda.sh
    - conda activate base
    - bdt ci clean-betas -vv
  cache:
    key: "linux-cache"
    paths:
      - miniconda.sh
      - ${CONDA_ROOT}/pkgs/*.tar.bz2
      - ${CONDA_ROOT}/pkgs/urls.txt


# The automatic clean-up takes place when the nightly successfuly runs
cleanup:
  extends: .cleanup_template


manual_cleanup:
  extends: .cleanup_template
  when: manual
  allow_failure: true
